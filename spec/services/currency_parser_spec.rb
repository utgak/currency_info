require "rails_helper"

RSpec.describe CurrencyParser do
  let(:raw_data) {"<?xml version=\"1.0\" encoding=\"windows-1251\"?><ValCurs Date=\"30.11.2023\" name=\"Foreign Currency Market\"><Valute ID=\"R01010\"><NumCode>036</NumCode><CharCode>AUD</CharCode><Nominal>1</Nominal><Name>\xC0\xE2\xF1\xF2\xF0\xE0\xEB\xE8\xE9\xF1\xEA\xE8\xE9 \xE4\xEE\xEB\xEB\xE0\xF0</Name><Value>59,1079</Value><VunitRate>59,1079</VunitRate></Valute><Valute ID=\"R01020A\"><NumCode>944</NumCode><CharCode>AZN</CharCode><Nominal>1</Nominal><Name>\xC0\xE7\xE5\xF0\xE1\xE0\xE9\xE4\xE6\xE0\xED\xF1\xEA\xE8\xE9 \xEC\xE0\xED\xE0\xF2</Name><Value>52,2848</Value><VunitRate>52,2848</VunitRate></Valute><Valute ID=\"R01035\"><NumCode>826</NumCode><CharCode>GBP</CharCode><Nominal>1</Nominal><Name>\xD4\xF3\xED\xF2 \xF1\xF2\xE5\xF0\xEB\xE8\xED\xE3\xEE\xE2 \xD1\xEE\xE5\xE4\xE8\xED\xE5\xED\xED\xEE\xE3\xEE \xEA\xEE\xF0\xEE\xEB\xE5\xE2\xF1\xF2\xE2\xE0</Name><Value>112,7317</Value><VunitRate>112,7317</VunitRate></Valute><Valute ID=\"R01060\"><NumCode>051</NumCode><CharCode>AMD</CharCode><Nominal>100</Nominal><Name>\xC0\xF0\xEC\xFF\xED\xF1\xEA\xE8\xF5 \xE4\xF0\xE0\xEC\xEE\xE2</Name><Value>22,0830</Value><VunitRate>0,22083</VunitRate></Valute><Valute ID=\"R01090B\"><NumCode>933</NumCode><CharCode>BYN</CharCode><Nominal>1</Nominal><Name>\xC1\xE5\xEB\xEE\xF0\xF3\xF1\xF1\xEA\xE8\xE9 \xF0\xF3\xE1\xEB\xFC</Name><Value>28,5388</Value><VunitRate>28,5388</VunitRate></Valute><Valute ID=\"R01100\"><NumCode>975</NumCode><CharCode>BGN</CharCode><Nominal>1</Nominal><Name>\xC1\xEE\xEB\xE3\xE0\xF0\xF1\xEA\xE8\xE9 \xEB\xE5\xE2</Name><Value>49,7588</Value><VunitRate>49,7588</VunitRate></Valute><Valute ID=\"R01115\"><NumCode>986</NumCode><CharCode>BRL</CharCode><Nominal>1</Nominal><Name>\xC1\xF0\xE0\xE7\xE8\xEB\xFC\xF1\xEA\xE8\xE9 \xF0\xE5\xE0\xEB</Name><Value>18,1901</Value><VunitRate>18,1901</VunitRate></Valute><Valute ID=\"R01135\"><NumCode>348</NumCode><CharCode>HUF</CharCode><Nominal>100</Nominal><Name>\xC2\xE5\xED\xE3\xE5\xF0\xF1\xEA\xE8\xF5 \xF4\xEE\xF0\xE8\xED\xF2\xEE\xE2</Name><Value>25,7964</Value><VunitRate>0,257964</VunitRate></Valute><Valute ID=\"R01150\"><NumCode>704</NumCode><CharCode>VND</CharCode><Nominal>10000</Nominal><Name>\xC2\xFC\xE5\xF2\xED\xE0\xEC\xF1\xEA\xE8\xF5 \xE4\xEE\xED\xE3\xEE\xE2</Name><Value>37,1698</Value><VunitRate>0,00371698</VunitRate></Valute><Valute ID=\"R01200\"><NumCode>344</NumCode><CharCode>HKD</CharCode><Nominal>1</Nominal><Name>\xC3\xEE\xED\xEA\xEE\xED\xE3\xF1\xEA\xE8\xE9 \xE4\xEE\xEB\xEB\xE0\xF0</Name><Value>11,4130</Value><VunitRate>11,413</VunitRate></Valute><Valute ID=\"R01210\"><NumCode>981</NumCode><CharCode>GEL</CharCode><Nominal>1</Nominal><Name>\xC3\xF0\xF3\xE7\xE8\xED\xF1\xEA\xE8\xE9 \xEB\xE0\xF0\xE8</Name><Value>32,7647</Value><VunitRate>32,7647</VunitRate></Valute><Valute ID=\"R01215\"><NumCode>208</NumCode><CharCode>DKK</CharCode><Nominal>1</Nominal><Name>\xC4\xE0\xF2\xF1\xEA\xE0\xFF \xEA\xF0\xEE\xED\xE0</Name><Value>13,0524</Value><VunitRate>13,0524</VunitRate></Valute><Valute ID=\"R01230\"><NumCode>784</NumCode><CharCode>AED</CharCode><Nominal>1</Nominal><Name>\xC4\xE8\xF0\xF5\xE0\xEC \xCE\xC0\xDD</Name><Value>24,2026</Value><VunitRate>24,2026</VunitRate></Valute><Valute ID=\"R01235\"><NumCode>840</NumCode><CharCode>USD</CharCode><Nominal>1</Nominal><Name>\xC4\xEE\xEB\xEB\xE0\xF0 \xD1\xD8\xC0</Name><Value>88,8841</Value><VunitRate>88,8841</VunitRate></Valute><Valute ID=\"R01239\"><NumCode>978</NumCode><CharCode>EUR</CharCode><Nominal>1</Nominal><Name>\xC5\xE2\xF0\xEE</Name><Value>97,6503</Value><VunitRate>97,6503</VunitRate></Valute><Valute ID=\"R01240\"><NumCode>818</NumCode><CharCode>EGP</CharCode><Nominal>10</Nominal><Name>\xC5\xE3\xE8\xEF\xE5\xF2\xF1\xEA\xE8\xF5 \xF4\xF3\xED\xF2\xEE\xE2</Name><Value>28,7701</Value><VunitRate>2,87701</VunitRate></Valute><Valute ID=\"R01270\"><NumCode>356</NumCode><CharCode>INR</CharCode><Nominal>10</Nominal><Name>\xC8\xED\xE4\xE8\xE9\xF1\xEA\xE8\xF5 \xF0\xF3\xEF\xE8\xE9</Name><Value>10,6656</Value><VunitRate>1,06656</VunitRate></Valute><Valute ID=\"R01280\"><NumCode>360</NumCode><CharCode>IDR</CharCode><Nominal>10000</Nominal><Name>\xC8\xED\xE4\xEE\xED\xE5\xE7\xE8\xE9\xF1\xEA\xE8\xF5 \xF0\xF3\xEF\xE8\xE9</Name><Value>57,5302</Value><VunitRate>0,00575302</VunitRate></Valute><Valute ID=\"R01335\"><NumCode>398</NumCode><CharCode>KZT</CharCode><Nominal>100</Nominal><Name>\xCA\xE0\xE7\xE0\xF5\xF1\xF2\xE0\xED\xF1\xEA\xE8\xF5 \xF2\xE5\xED\xE3\xE5</Name><Value>19,3630</Value><VunitRate>0,19363</VunitRate></Valute><Valute ID=\"R01350\"><NumCode>124</NumCode><CharCode>CAD</CharCode><Nominal>1</Nominal><Name>\xCA\xE0\xED\xE0\xE4\xF1\xEA\xE8\xE9 \xE4\xEE\xEB\xEB\xE0\xF0</Name><Value>65,4474</Value><VunitRate>65,4474</VunitRate></Valute><Valute ID=\"R01355\"><NumCode>634</NumCode><CharCode>QAR</CharCode><Nominal>1</Nominal><Name>\xCA\xE0\xF2\xE0\xF0\xF1\xEA\xE8\xE9 \xF0\xE8\xE0\xEB</Name><Value>24,4187</Value><VunitRate>24,4187</VunitRate></Valute><Valute ID=\"R01370\"><NumCode>417</NumCode><CharCode>KGS</CharCode><Nominal>100</Nominal><Name>\xCA\xE8\xF0\xE3\xE8\xE7\xF1\xEA\xE8\xF5 \xF1\xEE\xEC\xEE\xE2</Name><Value>99,8280</Value><VunitRate>0,99828</VunitRate></Valute><Valute ID=\"R01375\"><NumCode>156</NumCode><CharCode>CNY</CharCode><Nominal>1</Nominal><Name>\xCA\xE8\xF2\xE0\xE9\xF1\xEA\xE8\xE9 \xFE\xE0\xED\xFC</Name><Value>12,4527</Value><VunitRate>12,4527</VunitRate></Valute><Valute ID=\"R01500\"><NumCode>498</NumCode><CharCode>MDL</CharCode><Nominal>10</Nominal><Name>\xCC\xEE\xEB\xE4\xE0\xE2\xF1\xEA\xE8\xF5 \xEB\xE5\xE5\xE2</Name><Value>49,7830</Value><VunitRate>4,9783</VunitRate></Valute><Valute ID=\"R01530\"><NumCode>554</NumCode><CharCode>NZD</CharCode><Nominal>1</Nominal><Name>\xCD\xEE\xE2\xEE\xE7\xE5\xEB\xE0\xED\xE4\xF1\xEA\xE8\xE9 \xE4\xEE\xEB\xEB\xE0\xF0</Name><Value>54,8948</Value><VunitRate>54,8948</VunitRate></Valute><Valute ID=\"R01535\"><NumCode>578</NumCode><CharCode>NOK</CharCode><Nominal>10</Nominal><Name>\xCD\xEE\xF0\xE2\xE5\xE6\xF1\xEA\xE8\xF5 \xEA\xF0\xEE\xED</Name><Value>83,0615</Value><VunitRate>8,30615</VunitRate></Valute><Valute ID=\"R01565\"><NumCode>985</NumCode><CharCode>PLN</CharCode><Nominal>1</Nominal><Name>\xCF\xEE\xEB\xFC\xF1\xEA\xE8\xE9 \xE7\xEB\xEE\xF2\xFB\xE9</Name><Value>22,5148</Value><VunitRate>22,5148</VunitRate></Valute><Valute ID=\"R01585F\"><NumCode>946</NumCode><CharCode>RON</CharCode><Nominal>1</Nominal><Name>\xD0\xF3\xEC\xFB\xED\xF1\xEA\xE8\xE9 \xEB\xE5\xE9</Name><Value>19,6156</Value><VunitRate>19,6156</VunitRate></Valute><Valute ID=\"R01589\"><NumCode>960</NumCode><CharCode>XDR</CharCode><Nominal>1</Nominal><Name>\xD1\xC4\xD0 (\xF1\xEF\xE5\xF6\xE8\xE0\xEB\xFC\xED\xFB\xE5 \xEF\xF0\xE0\xE2\xE0 \xE7\xE0\xE8\xEC\xF1\xF2\xE2\xEE\xE2\xE0\xED\xE8\xFF)</Name><Value>118,5261</Value><VunitRate>118,5261</VunitRate></Valute><Valute ID=\"R01625\"><NumCode>702</NumCode><CharCode>SGD</CharCode><Nominal>1</Nominal><Name>\xD1\xE8\xED\xE3\xE0\xEF\xF3\xF0\xF1\xEA\xE8\xE9 \xE4\xEE\xEB\xEB\xE0\xF0</Name><Value>66,8101</Value><VunitRate>66,8101</VunitRate></Valute><Valute ID=\"R01670\"><NumCode>972</NumCode><CharCode>TJS</CharCode><Nominal>10</Nominal><Name>\xD2\xE0\xE4\xE6\xE8\xEA\xF1\xEA\xE8\xF5 \xF1\xEE\xEC\xEE\xED\xE8</Name><Value>81,1608</Value><VunitRate>8,11608</VunitRate></Valute><Valute ID=\"R01675\"><NumCode>764</NumCode><CharCode>THB</CharCode><Nominal>10</Nominal><Name>\xD2\xE0\xE8\xEB\xE0\xED\xE4\xF1\xEA\xE8\xF5 \xE1\xE0\xF2\xEE\xE2</Name><Value>25,6197</Value><VunitRate>2,56197</VunitRate></Valute><Valute ID=\"R01700J\"><NumCode>949</NumCode><CharCode>TRY</CharCode><Nominal>10</Nominal><Name>\xD2\xF3\xF0\xE5\xF6\xEA\xE8\xF5 \xEB\xE8\xF0</Name><Value>30,7527</Value><VunitRate>3,07527</VunitRate></Valute><Valute ID=\"R01710A\"><NumCode>934</NumCode><CharCode>TMT</CharCode><Nominal>1</Nominal><Name>\xCD\xEE\xE2\xFB\xE9 \xF2\xF3\xF0\xEA\xEC\xE5\xED\xF1\xEA\xE8\xE9 \xEC\xE0\xED\xE0\xF2</Name><Value>25,3955</Value><VunitRate>25,3955</VunitRate></Valute><Valute ID=\"R01717\"><NumCode>860</NumCode><CharCode>UZS</CharCode><Nominal>10000</Nominal><Name>\xD3\xE7\xE1\xE5\xEA\xF1\xEA\xE8\xF5 \xF1\xF3\xEC\xEE\xE2</Name><Value>72,1755</Value><VunitRate>0,00721755</VunitRate></Valute><Valute ID=\"R01720\"><NumCode>980</NumCode><CharCode>UAH</CharCode><Nominal>10</Nominal><Name>\xD3\xEA\xF0\xE0\xE8\xED\xF1\xEA\xE8\xF5 \xE3\xF0\xE8\xE2\xE5\xED</Name><Value>24,4426</Value><VunitRate>2,44426</VunitRate></Valute><Valute ID=\"R01760\"><NumCode>203</NumCode><CharCode>CZK</CharCode><Nominal>10</Nominal><Name>\xD7\xE5\xF8\xF1\xEA\xE8\xF5 \xEA\xF0\xEE\xED</Name><Value>39,9300</Value><VunitRate>3,993</VunitRate></Valute><Valute ID=\"R01770\"><NumCode>752</NumCode><CharCode>SEK</CharCode><Nominal>10</Nominal><Name>\xD8\xE2\xE5\xE4\xF1\xEA\xE8\xF5 \xEA\xF0\xEE\xED</Name><Value>85,1217</Value><VunitRate>8,51217</VunitRate></Valute><Valute ID=\"R01775\"><NumCode>756</NumCode><CharCode>CHF</CharCode><Nominal>1</Nominal><Name>\xD8\xE2\xE5\xE9\xF6\xE0\xF0\xF1\xEA\xE8\xE9 \xF4\xF0\xE0\xED\xEA</Name><Value>101,3849</Value><VunitRate>101,3849</VunitRate></Valute><Valute ID=\"R01805F\"><NumCode>941</NumCode><CharCode>RSD</CharCode><Nominal>100</Nominal><Name>\xD1\xE5\xF0\xE1\xF1\xEA\xE8\xF5 \xE4\xE8\xED\xE0\xF0\xEE\xE2</Name><Value>83,4291</Value><VunitRate>0,834291</VunitRate></Valute><Valute ID=\"R01810\"><NumCode>710</NumCode><CharCode>ZAR</CharCode><Nominal>10</Nominal><Name>\xDE\xE6\xED\xEE\xE0\xF4\xF0\xE8\xEA\xE0\xED\xF1\xEA\xE8\xF5 \xF0\xFD\xED\xE4\xEE\xE2</Name><Value>47,9635</Value><VunitRate>4,79635</VunitRate></Valute><Valute ID=\"R01815\"><NumCode>410</NumCode><CharCode>KRW</CharCode><Nominal>1000</Nominal><Name>\xC2\xEE\xED \xD0\xE5\xF1\xEF\xF3\xE1\xEB\xE8\xEA\xE8 \xCA\xEE\xF0\xE5\xFF</Name><Value>68,9238</Value><VunitRate>0,0689238</VunitRate></Valute><Valute ID=\"R01820\"><NumCode>392</NumCode><CharCode>JPY</CharCode><Nominal>100</Nominal><Name>\xDF\xEF\xEE\xED\xF1\xEA\xE8\xF5 \xE8\xE5\xED</Name><Value>60,5230</Value><VunitRate>0,60523</VunitRate></Valute></ValCurs>" }
  let(:raw_data_range) {"<?xml version=\"1.0\" encoding=\"windows-1251\"?><ValCurs ID=\"R01375\" DateRange1=\"17.11.2023\" DateRange2=\"01.12.2023\" name=\"Foreign Currency Market Dynamic\"><Record Date=\"17.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,2479</Value><VunitRate>12,2479</VunitRate></Record><Record Date=\"18.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3104</Value><VunitRate>12,3104</VunitRate></Record><Record Date=\"21.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3230</Value><VunitRate>12,323</VunitRate></Record><Record Date=\"22.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3009</Value><VunitRate>12,3009</VunitRate></Record><Record Date=\"23.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3026</Value><VunitRate>12,3026</VunitRate></Record><Record Date=\"24.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3225</Value><VunitRate>12,3225</VunitRate></Record><Record Date=\"25.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3949</Value><VunitRate>12,3949</VunitRate></Record><Record Date=\"28.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3842</Value><VunitRate>12,3842</VunitRate></Record><Record Date=\"29.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3685</Value><VunitRate>12,3685</VunitRate></Record><Record Date=\"30.11.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,4527</Value><VunitRate>12,4527</VunitRate></Record><Record Date=\"01.12.2023\" Id=\"R01375\"><Nominal>1</Nominal><Value>12,3927</Value><VunitRate>12,3927</VunitRate></Record></ValCurs>"}
  let!(:currency) { Currency.create!(name: 'Китайский юань', char_code: 'CNY', cbr_id: 'R01375') }
  
  it 'parses data from single day' do
    parsed_data = described_class.new(raw_data).daily_by_id(currency.cbr_id)
    expected_data = {rate: 0.124527e2.to_d, date: Date.current, currency: currency}
    
    expect(parsed_data).to eq expected_data
  end

  it 'parses data from range' do
    parsed_data = described_class.new(raw_data_range).dynamic
    expected_data =
    [
      {:currency=> currency,
        :date=>Date.parse('Fri, 17 Nov 2023'),
        :rate=>0.122479e2},
      {:currency=> currency,
        :date=>Date.parse('Sat, 18 Nov 2023'),
        :rate=>0.123104e2},
      {:currency=> currency,
        :date=>Date.parse('Tue, 21 Nov 2023'),
        :rate=>0.12323e2},
      {:currency=> currency,
        :date=>Date.parse('Wed, 22 Nov 2023'),
        :rate=>0.123009e2},
      {:currency=> currency,
        :date=>Date.parse('Thu, 23 Nov 2023'),
        :rate=>0.123026e2},
      {:currency=> currency,
        :date=>Date.parse('Fri, 24 Nov 2023'),
        :rate=>0.123225e2},
      {:currency=> currency,
        :date=>Date.parse('Sat, 25 Nov 2023'),
        :rate=>0.123949e2},
      {:currency=> currency,
        :date=>Date.parse('Tue, 28 Nov 2023'),
        :rate=>0.123842e2},
      {:currency=> currency,
        :date=>Date.parse('Wed, 29 Nov 2023'),
        :rate=>0.123685e2},
      {:currency=> currency,
        :date=>Date.parse('Thu, 30 Nov 2023'),
        :rate=>0.124527e2},
      {:currency=> currency,
        :date=>Date.parse('Fri, 01 Dec 2023'),
        :rate=>0.123927e2}
    ]

    
    expect(parsed_data).to eq expected_data
  end
end
